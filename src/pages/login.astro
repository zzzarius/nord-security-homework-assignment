---
import { LoginForm } from "@/components/LoginForm";
import Layout from "@/layouts/Layout.astro";
import { getToken } from "@/api/getToken";
import { BAD_CREDENTIALS, NO_USERNAME_OR_PASSWORD } from "@/api/errors";

export const prerender = false;

const existingToken = Astro.cookies.get("token")?.value;

if (existingToken) {
  Astro.cookies.delete("token");
}
let errorText = "";
let username = "";
let password = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  username = formData.get("username") as string;
  password = formData.get("password") as string;

  if (!username || !password) {
    errorText = NO_USERNAME_OR_PASSWORD;
  } else {
    let token: string | undefined;
    try {
      token = await getToken(username, password);
    } catch (_e) {
      errorText = BAD_CREDENTIALS;
    }

    if (!errorText && token) {
      Astro.cookies.set("token", token);
      return new Response(null, {
        status: 302,
        headers: {
          Location: "/",
        },
      });
    }
  }
}
---

<Layout>
  <div class="grid place-items-center mt-20.5 p-3.5 animate-in opacity-0">
    <LoginForm
      client:load
      errorText={errorText}
      username={username}
      password={password}
    />
  </div>
</Layout>
